# Documento de Requisitos de Produto
## Reframe Endpoint - Deploy P√∫blico em VPS com Easypanel

**Vers√£o:** 1.0  
**Data:** Dezembro 2024  
**Autor:** An√°lise de Requisitos T√©cnicos

---

## 1. VIS√ÉO GERAL DO PROJETO

### 1.1 Descri√ß√£o
Servi√ßo de API REST desenvolvido em Python/Flask que processa v√≠deos em tempo real para reenquadramento autom√°tico. O servi√ßo converte v√≠deos de 16:9 para formato 9:16 (vertical), utilizando MediaPipe para detectar e seguir o falante principal.

### 1.2 Tecnologias Utilizadas
- **Backend:** Flask + Gunicorn
- **Processamento:** MediaPipe, OpenCV
- **Storage:** DigitalOcean Spaces (boto3)
- **Containeriza√ß√£o:** Docker (via nixpacks.toml)
- **Deploy:** Easypanel + VPS

---

## 2. OBJETIVOS DO DEPLOY

### 2.1 Objetivo Principal
Disponibilizar o servi√ßo publicamente em VPS atrav√©s do Easypanel, permitindo que clientes externos enviem requisi√ß√µes de reframing de v√≠deos via API REST.

### 2.2 Casos de Uso
- Clientes externos via API REST
- Processamento ass√≠ncrono de v√≠deos
- Armazenamento p√∫blico de v√≠deos processados
- Callbacks para notifica√ß√£o de conclus√£o

---

## 3. AN√ÅLISE DO ESTADO ATUAL

### 3.1 Arquivos Existentes ‚úÖ
- ‚úÖ `app.py` - Aplica√ß√£o Flask principal
- ‚úÖ `Procfile` - Configura√ß√£o Heroku/Railway
- ‚úÖ `nixpacks.toml` - Configura√ß√£o Nixpacks/Docker
- ‚úÖ `requirements.txt` - Depend√™ncias Python
- ‚úÖ `reframe_mediapipe_falante_v7.py` - M√≥dulo de processamento
- ‚úÖ `storage/spaces.py` - Integra√ß√£o DigitalOcean Spaces

### 3.2 Arquivos Faltantes ‚ùå
1. **`.gitignore`** - Ignorar arquivos desnecess√°rios no reposit√≥rio
2. **`.env.example`** - Template de vari√°veis de ambiente
3. **README.md completo** - Documenta√ß√£o do projeto
4. **Configura√ß√£o CI/CD** - GitHub Actions (opcional mas recomendado)
5. **Documenta√ß√£o de API** - Swagger/OpenAPI (opcional)

---

## 4. REQUISITOS FUNCIONAIS

### 4.1 Endpoints da API

#### 4.1.1 Health Check
- **GET** `/` - Status do servi√ßo
- Retorna: `queue_size`, `workers`, status

#### 4.1.2 Enfileirar Processamento
- **POST** `/v1/video/reframe`
- **Body:**
  ```json
  {
    "input_url": "https://example.com/video.mp4",
    "callback_url": "https://example.com/webhook" // opcional
  }
  ```
- Retorna: `job_id`, status `queued`

#### 4.1.3 Status do Job
- **GET** `/v1/video/status/<job_id>`
- Retorna: progresso, stage atual, ETA, m√©tricas

#### 4.1.4 Listar Jobs
- **GET** `/v1/video/jobs?status=done&limit=50`
- Retorna: lista de jobs com filtros

#### 4.1.5 Download do V√≠deo
- **GET** `/v1/video/download/<job_id>`
- Retorna: arquivo ou URL p√∫blica

#### 4.1.6 Teste de Upload
- **POST** `/v1/test/upload`
- Testa conectividade com DigitalOcean Spaces

### 4.2 Fluxo de Processamento
1. **Queued** ‚Üí Job enfileirado
2. **Downloading** ‚Üí Download do v√≠deo de entrada
3. **Reframing** ‚Üí Processamento com MediaPipe
4. **Muxing** ‚Üí Incorpora√ß√£o de √°udio
5. **Uploading** ‚Üí Upload para Spaces
6. **Done** ‚Üí Conclu√≠do com URL p√∫blica

---

## 5. REQUISITOS N√ÉO FUNCIONAIS

### 5.1 Performance
- **Workers Paralelos:** Configur√°vel via `MAX_WORKERS` (default: 2)
- **Timeout:** 60s para download
- **Queue Management:** Sistema de fila com threading

### 5.2 Escalabilidade
- Suporte a m√∫ltiplos workers simult√¢neos
- Persist√™ncia de estado em `/tmp/job_*.json`
- Cleanup autom√°tico de arquivos tempor√°rios

### 5.3 Seguran√ßa
- **Vari√°veis de Ambiente:** Credenciais sens√≠veis via `.env`
- **Valida√ß√£o de Input:** Sanitiza√ß√£o de URLs e caminhos
- **Rate Limiting:** N√£o implementado (‚ö†Ô∏è pend√™ncia)
- **CORS:** N√£o configurado (‚ö†Ô∏è pend√™ncia)

### 5.4 Confiabilidade
- Tratamento de erros em todas as etapas
- Callback opcional para notifica√ß√£o de conclus√£o
- Fallback para salvar localmente se upload falhar
- Snapshot de jobs para recupera√ß√£o

---

## 6. DEPEND√äNCIAS E CONFIGURA√á√ÉO

### 6.1 Vari√°veis de Ambiente Necess√°rias

```bash
# DigitalOcean Spaces
SPACES_REGION=nyc3                    # Regi√£o do Space
SPACES_ENDPOINT=https://nyc3.digitaloceanspaces.com
SPACES_BUCKET=seu-bucket              # Nome do bucket
SPACES_KEY=SUA_KEY                    # Access Key
SPACES_SECRET=SUA_SECRET_KEY          # Secret Key
SPACES_CDN_BASE=https://cdn.example.com  # Opcional

# Configura√ß√£o do Servi√ßo
MAX_WORKERS=2                          # N√∫mero de workers (default: 2)
OUTPUT_PREFIX=reframes                 # Prefixo para uploads

# Porta (geralmente definida pelo container)
PORT=8080                               # Padr√£o para container

# Python (opcional para debug)
FLASK_ENV=production
```

### 6.2 Depend√™ncias Python
```txt
flask
requests
mediapipe
opencv-python-headless
numpy
boto3
python-dotenv
gunicorn  # ‚ùå FALTANDO - necess√°rio para produ√ß√£o
```

‚ö†Ô∏è **ISSUE CR√çTICA:** `gunicorn` n√£o est√° listado em `requirements.txt` mas √© usado no `Procfile`.

---

## 7. REQUISITOS DE INFRAESTRUTURA

### 7.1 Easypanel
- **Plataforma:** Container Linux
- **Build System:** Nixpacks (via `nixpacks.toml`)
- **Runtime:** Gunicorn (via `Procfile`)
- **Porta:** 8080 (configurada automaticamente)

### 7.2 Recursos Necess√°rios
- **CPU:** M√≠nimo 2 cores (recomendado 4+)
- **RAM:** M√≠nimo 2GB (recomendado 4GB+)
- **Disco:** 10GB+ para arquivos tempor√°rios
- **Bandwidth:** Alto para upload/download de v√≠deos

### 7.3 Pacotes Sistema
‚úÖ J√° configurado em `nixpacks.toml`:
- `ffmpeg` (necess√°rio para muxing de √°udio)

### 7.4 Storage Externo
- **DigitalOcean Spaces:** Configura√ß√£o S3-compatible
- **Bucket:** P√∫blico para upload de v√≠deos processados
- **CDN:** Opcional via `SPACES_CDN_BASE`

---

## 8. GAPS IDENTIFICADOS E CORRE√á√ïES NECESS√ÅRIAS

### 8.1 üî¥ CR√çTICO - Corre√ß√µes Obrigat√≥rias

#### 8.1.1 Adicionar `gunicorn` ao requirements.txt
**Problema:** Procfile usa gunicorn mas n√£o est√° instalado.

**Solu√ß√£o:**
```python
# requirements.txt - ADICIONAR:
gunicorn>=21.2.0
```

#### 8.2.2 Criar arquivo `.gitignore`
**Problema:** Arquivos desnecess√°rios sendo versionados.

**Arquivo necess√°rio:**
```
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
*.egg-info/

# Flask
instance/
.webassets-cache

# Media files
*.mp4
*.avi
*.mov
temp/

# Environment
.env
.env.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Project specific
/tmp/job_*.json
/tmp/test_upload.txt
```

### 8.2 üü° IMPORTANTE - Melhorias Recomendadas

#### 8.2.1 Criar `.env.example`
**Problema:** Desenvolvedores n√£o sabem quais vari√°veis configurar.

**Arquivo necess√°rio:**
```bash
# DigitalOcean Spaces
SPACES_REGION=nyc3
SPACES_ENDPOINT=https://nyc3.digitaloceanspaces.com
SPACES_BUCKET=seu-bucket
SPACES_KEY=sua-access-key
SPACES_SECRET=sua-secret-key
SPACES_CDN_BASE=  # Opcional

# Configura√ß√£o do Servi√ßo
MAX_WORKERS=2
OUTPUT_PREFIX=reframes
PORT=8080
```

#### 8.2.2 Melhorar `README.md`
**Status Atual:** Apenas "# reframe-endpoint"

**Conte√∫do necess√°rio:**
- Descri√ß√£o do projeto
- Instru√ß√µes de setup local
- Documenta√ß√£o da API
- Vari√°veis de ambiente
- Exemplos de uso
- Troubleshooting

### 8.3 üü¢ SUGERIDO - Otimiza√ß√µes Futuras

#### 8.3.1 Configurar CORS
```python
from flask_cors import CORS
CORS(app)  # ou CORS(app, resources={r"/*": {"origins": "https://meudominio.com"}})
```

#### 8.3.2 Implementar Rate Limiting
```python
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=["200 per day", "50 per hour"]
)
```

#### 8.3.3 Adicionar Logging Estruturado
```python
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

#### 8.3.4 Documenta√ß√£o OpenAPI/Swagger
```python
from flask_swagger_ui import get_swaggerui_blueprint
```

---

## 9. PLANO DE DEPLOY

### 9.1 Fase 1: Prepara√ß√£o do C√≥digo (ANTES DO PUSH)
1. ‚úÖ Criar `.gitignore`
2. ‚úÖ Adicionar `gunicorn` ao `requirements.txt`
3. ‚úÖ Criar `.env.example`
4. ‚úÖ Melhorar `README.md`
5. ‚úÖ Testar localmente com Docker

### 9.2 Fase 2: Push para GitHub
1. Inicializar reposit√≥rio (se n√£o existe)
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/seu-usuario/reframe-endpoint.git
   git push -u origin main
   ```

### 9.3 Fase 3: Configura√ß√£o Easypanel
1. Conectar reposit√≥rio GitHub no Easypanel
2. Configurar build via Nixpacks
3. Adicionar vari√°veis de ambiente no Easypanel
4. Configurar dom√≠nio/path (opcional)

### 9.4 Fase 4: Deploy e Teste
1. Deploy autom√°tico via GitHub
2. Testar endpoint de health: `GET /`
3. Testar upload: `POST /v1/test/upload`
4. Testar reframing: `POST /v1/video/reframe`
5. Monitorar logs

---

## 10. CHECKLIST DE DEPLOY

### 10.1 Antes do Deploy
- [ ] Criar arquivo `.gitignore`
- [ ] Adicionar `gunicorn` ao `requirements.txt`
- [ ] Criar arquivo `.env.example`
- [ ] Atualizar `README.md` com documenta√ß√£o completa
- [ ] Testar localmente com `docker build` (opcional)
- [ ] Verificar todas as vari√°veis de ambiente necess√°rias

### 10.2 Configura√ß√£o do Easypanel
- [ ] Criar novo app no Easypanel
- [ ] Conectar reposit√≥rio GitHub
- [ ] Adicionar vari√°veis de ambiente no painel
- [ ] Configurar porta 8080
- [ ] Verificar configura√ß√£o de build (nixpacks)

### 10.3 P√≥s-Deploy
- [ ] Testar health check: `curl https://seu-app.com/`
- [ ] Testar upload: `POST /v1/test/upload`
- [ ] Testar processamento completo
- [ ] Verificar logs no Easypanel
- [ ] Configurar dom√≠nio customizado (opcional)
- [ ] Configurar SSL/HTTPS (geralmente autom√°tico)

---

## 11. ARQUITETURA DE DEPLOY

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Cliente API   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ HTTP/HTTPS
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Easypanel (VPS)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ    Container Docker           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Flask + Gunicorn       ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  (Port 8080)            ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ Workers ‚îÇ                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îÇ  Queue  ‚îÇ                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ MediaPipe      ‚îÇ           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ OpenCV          ‚îÇ           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ FFmpeg          ‚îÇ           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ Upload
                    ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ DigitalOcean Spaces ‚îÇ
        ‚îÇ   (S3 Compatible)   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 12. TROUBLESHOOTING

### 12.1 Problemas Comuns

#### Erro: "gunicorn: command not found"
**Causa:** Gunicorn n√£o est√° em requirements.txt  
**Solu√ß√£o:** Adicionar `gunicorn` ao `requirements.txt`

#### Erro: "ModuleNotFoundError: No module named 'mediapipe'"
**Causa:** Depend√™ncias n√£o instaladas  
**Solu√ß√£o:** Verificar `requirements.txt` e build logs

#### Erro: "403 Forbidden - DigitalOcean Spaces"
**Causa:** Credenciais inv√°lidas  
**Solu√ß√£o:** Verificar `SPACES_KEY` e `SPACES_SECRET`

#### Erro: "ffmpeg: command not found"
**Causa:** FFmpeg n√£o instalado no container  
**Solu√ß√£o:** Verificar `nixpacks.toml` - deve conter `"ffmpeg"`

#### Timeout no download
**Causa:** V√≠deo muito grande ou conex√£o lenta  
**Solu√ß√£o:** Aumentar timeout ou usar v√≠deos menores

---

## 13. M√âTRICAS E MONITORAMENTO

### 13.1 Endpoints de Monitoramento
- `GET /` - Health check simples
- `GET /v1/video/jobs` - Status da fila

### 13.2 M√©tricas Recomendadas (Implementar Futuramente)
- Taxa de sucesso/erro
- Tempo m√©dio de processamento
- Uso de CPU/RAM
- Tamanho m√©dio de v√≠deos

---

## 14. SEGURAN√áA

### 14.1 Implementado ‚úÖ
- Vari√°veis de ambiente para credenciais
- Valida√ß√£o b√°sica de input
- Cleanup de arquivos tempor√°rios

### 14.2 Pendente ‚ö†Ô∏è
- **Rate Limiting** - Prevenir abuso
- **CORS** - Controlar origens permitidas
- **Autentica√ß√£o** - API keys ou tokens
- **HTTPS** - Geralmente autom√°tico no Easypanel
- **Input Validation** - Limitar tamanho de v√≠deos

---

## 15. ESCALABILIDADE FUTURA

### 15.1 Quando Crescer
- **Redis** para fila distribu√≠da
- **Celery** para processamento ass√≠ncrono
- **Kubernetes** para scaling horizontal
- **S3/CDN** para distribui√ß√£o global
- **Database** para persist√™ncia de jobs

---

## 16. CONCLUS√ÉO

### 16.1 Estado Atual
‚úÖ **Quase pronto para deploy!** O projeto est√° bem estruturado e funcionalmente completo.

### 16.2 A√ß√µes Necess√°rias Antes do Deploy P√∫blico

**CR√çTICO (Fazer agora):**
1. Adicionar `gunicorn` ao `requirements.txt`
2. Criar arquivo `.gitignore`
3. Criar arquivo `.env.example`
4. Atualizar `README.md` com documenta√ß√£o

**Importante (Fazer em breve):**
5. Implementar CORS
6. Adicionar Rate Limiting
7. Melhorar tratamento de erros
8. Adicionar logging estruturado

**Opcional (Melhorias futuras):**
9. Documenta√ß√£o OpenAPI
10. Testes automatizados
11. CI/CD pipeline
12. Monitoramento avan√ßado

### 16.3 Estimativa
- **Tempo de corre√ß√£o:** ~1 hora (cr√≠ticas)
- **Tempo de deploy:** ~30 minutos (EasyPanel)
- **Total para produ√ß√£o:** ~2 horas

---

**Pr√≥ximos Passos Recomendados:**
1. Implementar as corre√ß√µes cr√≠ticas (itens 1-4)
2. Fazer push para GitHub
3. Configurar no Easypanel
4. Fazer deploy e testes
5. Monitorar e iterar

---

*Documento gerado automaticamente em: {{DATA_ATUAL}}*

